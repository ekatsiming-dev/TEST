<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 工作坊報名儀表板 (N=61)</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 Leaflet.js (地圖) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- 載入 Chart.js (圖表) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 載入 Google Fonts (Noto Sans TC) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* * ---------------------------------------------------
         * 階段一：設計風格指南 (Style Guide)
         * 風格：電影風格 × 莫蘭迪色 × 遮罩效果
         * 色彩：霧米 #D9C8B4, 灰藍 #A7B5BD, 駝金 #CBB9A8, 暖灰 #B6AFA3
         * 字體：Noto Sans TC
         * ---------------------------------------------------
         */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #D9C8B4; /* 霧米 */
        }

        .bg-morandi-base { background-color: #D9C8B4; }
        .bg-morandi-blue { background-color: #A7B5BD; }
        .bg-morandi-gold { background-color: #CBB9A8; }
        .bg-morandi-warm-gray { background-color: #B6AFA3; }
        
        .text-morandi-dark { color: #5a5a5a; }
        .text-morandi-light { color: #f0f0f0; }

        .cinematic-mask {
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .cinematic-mask::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.02) 100%);
            pointer-events: none;
            z-index: 1;
            border-radius: 0.75rem;
        }

        #map {
            /* 調整高度以容納地區標籤 */
            height: 460px; 
            width: 100%;
            border-radius: 0.75rem;
            z-index: 5;
        }
        
        /* 移除固定的 chart-container 高度，改用 inline style */
        
        #group-chart-container {
             height: 450px;
             padding-top: 20px;
         }

        .morandi-marker-icon {
            background-color: #D87B6C; /* 維持跳色：陶土紅 */
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .morandi-marker-icon::after {
            content: '';
            width: 8px;
            height: 8px;
            background-color: #ffffff;
            border-radius: 50%;
        }

        .cinematic-title {
            letter-spacing: 0.05em;
        }
        
        .data-badge {
            font-size: 0.75rem;
            background-color: #fef3c7; /* 淺黃 */
            color: #92400e; /* 深黃褐 */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-morandi-base text-morandi-dark p-4 md:p-8 transition-all duration-500 ease-in-out">

    <div class="max-w-7xl mx-auto space-y-8">

        <header class="text-center p-6">
            <h1 class="text-3xl md:text-4xl font-bold cinematic-title">
                AI 工作坊 報名儀表板(2025/11/23)
            </h1>
        </header>

        <!-- KPI 區 (依據 分組名單 N=61) -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-morandi-blue cinematic-mask p-6 text-white">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold opacity-80">總報名人數</h2>
                    <!-- 更新：資料來源 N=61 -->
                    <span class="data-badge" style="background-color: #A7B5BD; color: #fff;">來源: 分組名單 (N=61)</span>
                </div>
                <!-- 更新：使用 N=61 -->
                <p id="kpi-total" class="text-4xl font-bold mt-2">61</p>
            </div>
            <div class="bg-morandi-gold cinematic-mask p-6 text-morandi-dark">
                <h2 class="text-lg font-semibold opacity-80">院外人員</h2>
                <!-- 更新：使用 N=21 -->
                <p id="kpi-external" class="text-4xl font-bold mt-2">21</p>
            </div>
            <div class="bg-morandi-warm-gray cinematic-mask p-6 text-morandi-dark">
                <h2 class="text-lg font-semibold opacity-80">奇美醫院同仁</h2>
                <!-- 更新：使用 N=40 -->
                <p id="kpi-internal" class="text-4xl font-bold mt-2">40</p>
            </div>
        </section>

        <!-- 
         * ---------------------------------------------------
         * 移除：學員背景分析 (依據 N=61 職類分析)
         * ---------------------------------------------------
        -->
        
        <!-- 圖表區 (地圖 & 佔比) -->
        <section class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            
            <!-- 地圖 (更新：依據 N=21 院外人員) -->
            <div class="lg:col-span-3 bg-white cinematic-mask p-4 md:p-6">
                <h2 class="text-xl font-bold mb-1">院外人員地理分佈</h2>
                <!-- 更新：使用 N=21 (動態更新) -->
                <p id="map-subtitle" class="text-sm opacity-70">(來源: 院外人員, N=21, 標記 20/21 人，1人無法定位)</p>
                
                <!-- 新增：地區人數統計容器 -->
                <div id="city-counts-container" class="flex flex-wrap gap-2 mt-2 mb-4">
                    <!-- 內容將由 JavaScript 動態填入 -->
                </div>
                
                <div id="map" class="mt-0"></div>
            </div>

            <!-- 右側圖表 (垂直堆疊) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 環圈圖 (依據 N=61) -->
                <div class="bg-white cinematic-mask p-4 md:p-6">
                    <h2 class="text-xl font-bold mb-1">報名身份佔比</h2>
                    <!-- 更新：使用 N=61 -->
                    <p class="text-sm opacity-70 mb-4">(來源: 分組名單, N=61)</p>
                    <!-- 更新：調整高度 -->
                    <div id="identity-chart-container" style="height: 230px;" class="flex items-center justify-center">
                        <canvas id="identityChart"></canvas>
                    </div>
                </div>

                <!-- 新增：決策者 vs 執行者 環圈圖 -->
                <div class="bg-white cinematic-mask p-4 md:p-6">
                    <h2 class="text-xl font-bold mb-1">決策者 vs 執行者 (百分比)</h2>
                    <p class="text-sm opacity-70 mb-4">
                        (來源: 職稱分析, N=61)
                    </p>
                    <div id="role-chart-container" style="height: 230px;" class="flex items-center justify-center">
                        <canvas id="decisionMakerChart"></canvas>
                    </div>
                </div>

            </div>

        </section>
        
        <!-- 更新：分組長條圖 (依據 N=61 職類分析) -->
        <section class="bg-white cinematic-mask p-4 md:p-6">
             <div class="flex justify-between items-center mb-1">
                <!-- 更新：標題 -->
                <h2 class="text-xl font-bold">各組成員職類結構</h2>
                <!-- 更新：N=61 -->
                <span class="data-badge">來源: 分組名單 (N=61)</span>
             </div>
            <!-- 更新：說明文字 -->
            <p class="text-sm opacity-70 mb-4">
                顯示 N=61 位成員在各組的「資訊」、「臨床」、「非臨床」職類結構。
            </p>
            <div id="group-chart-container">
                <canvas id="groupChart"></canvas>
            </div>
        </section>

    </div>

    <script type="module">
        // ---------------------------------------------------
        // 階段三：模組化元件 (資料處理與圖表邏輯)
        // ---------------------------------------------------

        // ----- (重大更新) 資料來源：單一事實來源 (N=61) -----
        // 由 Python 腳本分析產生的最終數據
        const finalDashboardData = {
            "totalCount": 61,
            "totalExternal": 21,
            "totalInternal": 40,
            "roleKpi": {
                "it": 5,
                "clinical": 24,
                "nonClinical": 32
            },
            // ----- 新增：決策者 vs 執行者 (範例資料) -----
            // !! 請注意：請在此處填入您統計的實際數字
            "decisionMakerKpi": {
                "decisionMakers": 15, // 範例資料 (決策者)
                "implementers": 46  // 範例資料 (執行者)
            },
            // ------------------------------------------
            "externalParticipantsList": [
                {"group": "第一組", "unit": "李俊杰診所"},
                {"group": "第一組", "unit": "德幼小兒科"},
                {"group": "第二組", "unit": "大林慈濟醫院院長室醫院發展組"},
                {"group": "第二組", "unit": "復華耳鼻喉科診所"},
                {"group": "第三組", "unit": "高雄榮民總醫院教學研究部"},
                {"group": "第三組", "unit": "晉慶眼科診所"},
                {"group": "第三組", "unit": "歐洲工商管理學院"},
                {"group": "第四組", "unit": "中山大學精準醫學所"},
                {"group": "第四組", "unit": "中山大學精準醫學所"},
                {"group": "第四組", "unit": "黃清相診所"},
                {"group": "第五組", "unit": "高雄醫學大學醫學系"},
                {"group": "第五組", "unit": "高雄醫學大學醫學系"},
                {"group": "第五組", "unit": "正信診所"},
                {"group": "第六組(貓頭鷹)", "unit": "大林慈濟醫院教學部"},
                {"group": "第六組(貓頭鷹)", "unit": "大林慈濟醫院教學部"},
                {"group": "第六組(貓頭鷹)", "unit": "三愛診所"},
                {"group": "第六組(貓頭鷹)", "unit": "國光生物科技股份有限公司"},
                {"group": "第七組(貓頭W鷹)", "unit": "成大醫院受試者保護中心"},
                {"group": "第七組(貓頭鷹)", "unit": "大林慈濟醫院教學部"},
                {"group": "第七組(貓頭鷹)", "unit": "寶建醫院護理部"},
                {"group": "第七組(貓頭鷹)", "unit": "樹德科技大學"}
            ],
            "groupRoleData": {
                "labels": ["第一組", "第二組", "第三組", "第四組", "第五組", "第六組(貓頭鷹)", "第七組(貓頭鷹)"],
                "it": [0, 1, 2, 0, 1, 1, 0],
                "clinical": [6, 4, 0, 4, 1, 4, 5],
                "nonClinical": [3, 4, 7, 4, 6, 4, 4]
            }
        };
        
        // ----- (保留) 院外人員服務單位與經緯度 (Geocoding) -----
        // 這是我們手動建立的地理編碼字典 (N=13 個地點)
        // ** (更新) 新增 "city" 屬性 **
        const externalLocations = {
            "中山大學": { lat: 22.6295, lon: 120.2662, name: "中山大學", city: "高雄市" },
            "成大醫院": { lat: 22.9996, lon: 120.2223, name: "成大醫院", city: "台南市" },
            "大林慈濟醫院": { lat: 23.5935, lon: 120.4658, name: "大林慈濟醫院", city: "嘉義縣" },
            "高雄榮民總醫院": { lat: 22.6744, lon: 120.3233, name: "高雄榮民總醫院", city: "高雄市" },
            "寶建醫院": { lat: 22.6808, lon: 120.4850, name: "寶建醫院", city: "屏東縣" },
            "李俊杰診所": { lat: 22.9934, lon: 120.2127, name: "李俊杰診所", city: "台南市" },
            "三愛診所": { lat: 23.0033, lon: 120.2163, name: "三愛診所", city: "台南市" },
            "德幼小兒科": { lat: 23.0063, lon: 120.2114, name: "德幼小兒科", city: "台南市" },
            "復華耳鼻喉科診所": { lat: 23.0090, lon: 120.2274, name: "復華耳鼻喉科診所", city: "台南市" },
            "晉慶眼科診所": { lat: 23.0001, lon: 120.2130, name: "晉慶眼科診所", city: "台南市" },
            "正信診所": { lat: 23.0232, lon: 120.2241, name: "正信診所", city: "台南市" },
            "黃清相診所": { lat: 23.0253, lon: 120.2198, name: "黃清相診所", city: "台南市" },
            "高雄醫學大學": { lat: 22.6465, lon: 120.3010, name: "高雄醫學大學", city: "高雄市" },
            "國光生物科技": { lat: 24.2154, lon: 120.6022, name: "國光生物科技", city: "台中市" }, // 新增
            "樹德科技大學": { lat: 22.7091, lon: 120.3473, name: "樹德科技大學", city: "高雄市" }  // 新增
            // "歐洲工商管理學院" 刻意省略 (無法定位)
        };
        
        // ----- Chart.js 莫蘭迪風格全域設定 -----
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
        Chart.defaults.color = '#5a5a5a';
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.legend.labels.padding = 20;

        // ----- DOM 載入後執行 -----
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 0. 動態更新所有 KPI 數字 ---
            // (移除 roleKpi 的更新)
            document.getElementById('kpi-total').textContent = finalDashboardData.totalCount;
            document.getElementById('kpi-external').textContent = finalDashboardData.totalExternal;
            document.getElementById('kpi-internal').textContent = finalDashboardData.totalInternal;
            
            // --- 1. 身份佔比圖 (依據 N=61) ---
            const ctxIdentity = document.getElementById('identityChart').getContext('2d');
            new Chart(ctxIdentity, {
                type: 'doughnut',
                data: {
                    labels: ['院外人員', '奇美醫院同仁'],
                    datasets: [{
                        label: '報名身份',
                        // 更新：使用 N=61 的資料
                        data: [finalDashboardData.totalExternal, finalDashboardData.totalInternal], 
                        backgroundColor: [
                            '#CBB9A8', // 駝金
                            '#B6AFA3', // 暖灰
                        ],
                        borderColor: '#FFFFFF',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // --- 2. 地理分佈圖 (依據 N=21 院外人員) ---
            const map = L.map('map').setView([23.1, 120.3], 9); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            const morandiIcon = L.divIcon({
                className: 'morandi-marker-icon',
                iconSize: [20, 20]
            });

            // (更新) 處理 N=21 的資料，並使用模糊比對
            const locationsToMark = {};
            const cityCounts = {}; // ** (新增) 用於統計各地區人數 **
            let mappedCount = 0;
            const totalExternal = finalDashboardData.totalExternal;
            const locationKeys = Object.keys(externalLocations);

            // 輔助函式：比對 'unit' 字串是否包含 'externalLocations' 的任一 key
            function findLocationInfo(unitString) {
                for (const key of locationKeys) {
                    if (unitString.includes(key)) {
                        return externalLocations[key];
                    }
                }
                return null; // 找不到
            }

            finalDashboardData.externalParticipantsList.forEach(person => {
                const locationInfo = findLocationInfo(person.unit);
                
                if (locationInfo) {
                    mappedCount++; // 成功 mapping 的人數
                    const geoKey = `${locationInfo.lat},${locationInfo.lon}`;
                    if (!locationsToMark[geoKey]) {
                        locationsToMark[geoKey] = { info: locationInfo, count: 0 };
                    }
                    locationsToMark[geoKey].count++;

                    // ** (新增) 開始統計地區人數 **
                    const city = locationInfo.city;
                    if (city) {
                        cityCounts[city] = (cityCounts[city] || 0) + 1;
                    }
                    // ** (新增) 統計結束 **
                }
                // '歐洲工商管理學院' 等找不到的會被自動跳過
            });

            // 動態更新地圖副標題
            const subtitleEl = document.getElementById('map-subtitle');
            subtitleEl.textContent = `(來源: 院外人員, N=${totalExternal}, 標記 ${mappedCount}/${totalExternal} 人)`;

            // ** (新增) 渲染地區人數標籤 **
            const cityContainer = document.getElementById('city-counts-container');
            cityContainer.innerHTML = ''; // 清空

            // 依人數由多到少排序
            const sortedCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]); 

            for (const [city, count] of sortedCities) {
                const badge = document.createElement('span');
                badge.className = 'data-badge'; // 重複使用 data-badge 樣式
                badge.style.backgroundColor = '#B6AFA3'; // 使用暖灰色
                badge.style.color = '#ffffff'; // 使用白色文字
                badge.textContent = `${city} ${count} 人`;
                cityContainer.appendChild(badge);
            }
            // ** (新增) 渲染結束 **


            Object.values(locationsToMark).forEach(loc => {
                const popupContent = `
                    <div style="font-family: 'Noto Sans TC', sans-serif;">
                        <strong style="font-size: 1.1em;">${loc.info.name}</strong><br>
                        報名人數： ${loc.count} 人
                    </div>
                `;
                L.marker([loc.info.lat, loc.info.lon], { icon: morandiIcon })
                    .addTo(map)
                    .bindPopup(popupContent);
            });

            // --- 3. 更新：分組長條圖 (依據 N=61 職類分析) ---
            const ctxGroup = document.getElementById('groupChart').getContext('2d');
            new Chart(ctxGroup, {
                type: 'bar',
                data: {
                    labels: finalDashboardData.groupRoleData.labels,
                    datasets: [
                        {
                            label: '資訊',
                            data: finalDashboardData.groupRoleData.it,
                            backgroundColor: '#A7B5BD', // 灰藍
                        },
                        {
                            label: '臨床',
                            data: finalDashboardData.groupRoleData.clinical,
                            backgroundColor: '#CBB9A8', // 駝金
                        },
                        {
                            label: '非臨床',
                            data: finalDashboardData.groupRoleData.nonClinical,
                            backgroundColor: '#B6AFA3', // 暖灰
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // 保留總計功能
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return '本組總計: ' + sum + ' 人';
                                }
                            }
                        }
                    }
                }
            });

            // --- 4. 新增：決策者 vs 執行者 (範例) ---
            const ctxDecisionMaker = document.getElementById('decisionMakerChart').getContext('2d');
            new Chart(ctxDecisionMaker, {
                type: 'doughnut',
                data: {
                    labels: ['決策者', '執行者'],
                    datasets: [{
                        label: '角色佔比',
                        data: [
                            finalDashboardData.decisionMakerKpi.decisionMakers, 
                            finalDashboardData.decisionMakerKpi.implementers
                        ],
                        backgroundColor: [
                            '#A7B5BD', // 灰藍
                            '#D9C8B4'  // 霧米
                        ],
                        borderColor: '#FFFFFF',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // 新增：顯示百分比
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const total = context.chart.getDatasetMeta(0).total;
                                        const value = context.parsed;
                                        const percentage = ((value / total) * 100).toFixed(1) + '%';
                                        label += `${value} 人 (${percentage})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

        });

    </script>
</body>
</html>
