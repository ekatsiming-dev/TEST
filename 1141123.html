<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 工作坊報名儀表板 (N=61)</title>
    
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 Leaflet.js (地圖) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- 載入 Chart.js (圖表) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 載入 Google Fonts (Noto Sans TC) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* * ---------------------------------------------------
         * (全新) 階段一：設計風格指南 (Style Guide)
         * 風格：專業品牌風格 (高對比)
         * 色彩：院內 #003566, 院外 #fca311, 中性色 #6b7280, 基底 #f8fafc
         * ---------------------------------------------------
         */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc; /* 基底 */
        }

        .bg-brand-base { background-color: #f8fafc; }
        .bg-brand-main { background-color: #003566; } /* (全新) 院內 (品牌藍) */
        .bg-brand-accent { background-color: #fca311; } /* (全新) 院外 (品牌琥珀) */
        .bg-brand-neutral { background-color: #6b7280; } /* (全新) 中性色 (灰色) */
        
        .text-brand-dark { color: #1f2937; } /* slate-800 */
        .text-brand-light { color: #f8fafc; }

        .cinematic-mask {
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .cinematic-mask::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.02) 100%);
            pointer-events: none;
            z-index: 1;
            border-radius: 0.75rem;
        }

        #map {
            /* 調整高度以容納地區標籤 */
            height: 460px; 
            width: 100%;
            border-radius: 0.75rem;
            z-index: 5;
        }
        
        #group-chart-container {
             height: 450px;
             padding-top: 20px;
         }

        .morandi-marker-icon {
            background-color: #fca311; /* (全新) 院外 (品牌琥珀) */
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .morandi-marker-icon::after {
            content: '';
            width: 8px;
            height: 8px;
            background-color: #ffffff;
            border-radius: 50%;
        }
        
        .morandi-marker-icon-internal {
            background-color: #003566; /* (全新) 院內 (品牌藍) */
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .morandi-marker-icon-internal::after {
            content: '';
            width: 8px;
            height: 8px;
            background-color: #ffffff;
            border-radius: 50%;
        }

        .cinematic-title {
            letter-spacing: 0.05em;
        }
        
        .data-badge {
            font-size: 0.75rem;
            background-color: #fef9c3; 
            color: #92400e; 
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-brand-base text-brand-dark p-4 md:p-8 transition-all duration-500 ease-in-out">

    <div class="max-w-7xl mx-auto space-y-8">

        <header class="text-center p-6">
            <h1 class="text-3xl md:text-4xl font-bold cinematic-title">
                AI 工作坊 報名儀表板(2025/11/23)
            </h1>
        </header>

        <!-- (全新) KPI 區配色 -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-brand-neutral cinematic-mask p-6 text-brand-light"> <!-- 總報名 -> 中性灰 -->
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold opacity-80">總報名人數</h2>
                    <span class="data-badge" style="background-color: #6b7280; color: #ffffff;">來源: 分組名單 (N=61)</span>
                </div>
                <p id="kpi-total" class="text-4xl font-bold mt-2">61</p>
            </div>
            <div class="bg-brand-accent cinematic-mask p-6 text-brand-dark"> <!-- 院外 -> 琥珀黃 -->
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-semibold opacity-80">院外人員</h2>
                    <span class="data-badge" style="background-color: #fca311; color: #1f2937;">來源: 分組名單 (N=21)</span>
                </div>
                <p id="kpi-external" class="text-4xl font-bold mt-2">21</p>
            </div>
            <div class="bg-brand-main cinematic-mask p-6 text-brand-light"> <!-- 院內 -> 品牌藍 -->
                <h2 class="text-lg font-semibold opacity-80">奇美醫院同仁</h2>
                <span class="data-badge" style="background-color: #003566; color: #ffffff;">來源: 分組名單 (N=40)</span>
                <p id="kpi-internal" class="text-4xl font-bold mt-2">40</p>
            </div>
        </section>
        
        <!-- 圖表區 (地圖 & 佔比) -->
        <section class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            
            <!-- 地圖 -->
            <div class="lg:col-span-3 bg-white cinematic-mask p-4 md:p-6">
                <h2 class="text-xl font-bold mb-1">報名人員地理分佈</h2>
                <p id="map-subtitle" class="text-sm opacity-70">(來源: 全體人員, N=61, 標記 60/61 人)</p>
                
                <!-- (全新) 地區人數標籤配色 -->
                <div id="city-counts-container" class="flex flex-wrap gap-2 mt-2 mb-4">
                    <!-- 內容將由 JavaScript 動態填入 -->
                </div>
                
                <div id="map" class="mt-0"></div>
            </div>

            <!-- 右側圖表 (垂直堆疊) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- (合併) 全體人員背景分析 -->
                <div class="bg-white cinematic-mask p-4 md:p-6">
                    <h2 class="text-xl font-bold mb-1">全體人員背景分析</h2>
                    <p class="text-sm opacity-70 mb-4">(來源: 分組名單, N=61)</p>
                    <div id="combined-analysis-chart-container" style="height: 460px;" class="flex items-center justify-center">
                        <canvas id="combinedAnalysisChart"></canvas>
                    </div>
                </div>

            </div>

        </section>
        
        <!-- 分組長條圖 -->
        <section class="bg-white cinematic-mask p-4 md:p-6">
             <div class="flex justify-between items-center mb-1">
                <h2 class="text-xl font-bold">各組成員職類結構</h2>
                <span class="data-badge" style="background-color: #f8fafc; color: #1f2937;">來源: 分組名單 (N=61)</span>
             </div>
            <p class="text-sm opacity-70 mb-4">
                顯示 N=61 位成員在各組的「資訊」、「臨床」、「非臨床」職類結構。
            </p>
            <div id="group-chart-container">
                <canvas id="groupChart"></canvas>
            </div>
        </section>

    </div>

    <script type="module">
        // ---------------------------------------------------
        // 階段三：模組化元件 (資料處理與圖表邏輯)
        // ---------------------------------------------------

        // ----- 資料來源 (N=61) -----
        const finalDashboardData = {
            "totalCount": 61,
            "totalExternal": 21,
            "totalInternal": 40,
            "roleKpi": {
                "it": 5,
                "clinical": 24,
                "nonClinical": 32
            },
            "decisionMakerKpi": {
                "decisionMakers": 15, 
                "implementers": 46
            },
            "externalParticipantsList": [
                {"group": "第一組", "unit": "李俊杰診所"},
                {"group": "第一組", "unit": "德幼小兒科"},
                {"group": "第二組", "unit": "大林慈濟醫院院長室醫院發展組"},
                {"group": "第二組", "unit": "復華耳鼻喉科診所"},
                {"group": "第三組", "unit": "高雄榮民總醫院教學研究部"},
                {"group": "第三組", "unit": "晉慶眼科診所"},
                {"group": "第三組", "unit": "歐洲工商管理學院"},
                {"group": "第四組", "unit": "中山大學精準醫學所"},
                {"group": "第四組", "unit": "中山大學精準醫學所"},
                {"group": "第四組", "unit": "黃清相診所"},
                {"group": "第五組", "unit": "高雄醫學大學醫學系"},
                {"group": "第五組", "unit": "高雄醫學大學醫學系"},
                {"group": "第五組", "unit": "正信診所"},
                {"group": "第六組(貓頭鷹)", "unit": "大林慈濟醫院教學部"},
                {"group": "第六組(貓頭鷹)", "unit": "大林慈濟醫院教學部"},
                {"group": "第六組(貓頭鷹)", "unit": "三愛診所"},
                {"group": "第六組(貓頭鷹)", "unit": "國光生物科技股份有限公司"},
                {"group": "第七組(貓頭W鷹)", "unit": "成大醫院受試者保護中心"},
                {"group": "第七組(貓頭鷹)", "unit": "大林慈濟醫院教學部"},
                {"group": "第七組(貓頭鷹)", "unit": "寶建醫院護理部"},
                {"group": "第七組(貓頭鷹)", "unit": "樹德科技大學"}
            ],
            "groupRoleData": {
                "labels": ["第一組", "第二組", "第三組", "第四組", "第五組", "第六組(貓頭鷹)", "第七組(貓頭鷹)"],
                "it": [0, 1, 2, 0, 1, 1, 0],
                "clinical": [6, 4, 0, 4, 1, 4, 5],
                "nonClinical": [3, 4, 7, 4, 6, 4, 4]
            },
            "externalAnalysis": {
                "byType": {
                    "醫院": 14,
                    "學校": 6,
                    "其他": 1
                },
                "byHospitalLevel": {
                    "醫學中心": 6,
                    "診所": 7,
                    "地區醫院": 1
                }
            }
        };
        
        // ----- 地理編碼字典 -----
        const externalLocations = {
            "奇美醫院": { lat: 23.021, lon: 120.241, name: "奇美醫院", city: "台南市", type: "internal" },
            "中山大學": { lat: 22.6295, lon: 120.2662, name: "中山大學", city: "高雄市", type: "external" },
            "成大醫院": { lat: 22.9996, lon: 120.2223, name: "成大醫院", city: "台南市", type: "external" },
            "大林慈濟醫院": { lat: 23.5935, lon: 120.4658, name: "大林慈濟醫院", city: "嘉義縣", type: "external" },
            "高雄榮民總醫院": { lat: 22.6744, lon: 120.3233, name: "高雄榮民總醫院", city: "高雄市", type: "external" },
            "寶建醫院": { lat: 22.6808, lon: 120.4850, name: "寶建醫院", city: "屏東縣", type: "external" },
            "李俊杰診所": { lat: 22.9934, lon: 120.2127, name: "李俊杰診所", city: "台南市", type: "external" },
            "三愛診所": { lat: 23.0033, lon: 120.2163, name: "三愛診所", city: "台南市", type: "external" },
            "德幼小兒科": { lat: 23.0063, lon: 120.2114, name: "德幼小兒科", city: "台南市", type: "external" },
            "復華耳鼻喉科診所": { lat: 23.0090, lon: 120.2274, name: "復華耳鼻喉科診所", city: "台南市", type: "external" },
            "晉慶眼科診所": { lat: 23.0001, lon: 120.2130, name: "晉慶眼科診所", city: "台南市", type: "external" },
            "正信診所": { lat: 23.0232, lon: 120.2241, name: "正信診所", city: "台南市", type: "external" },
            "黃清相診所": { lat: 23.0253, lon: 120.2198, name: "黃清相診所", city: "台南市", type: "external" },
            "高雄醫學大學": { lat: 22.6465, lon: 120.3010, name: "高雄醫學大學", city: "高雄市", type: "external" },
            "國光生物科技": { lat: 24.2154, lon: 120.6022, name: "國光生物科技", city: "台中市", type: "external" },
            "樹德科技大學": { lat: 22.7091, lon: 120.3473, name: "樹德科技大學", city: "高雄市", type: "external" }
        };
        
        // ----- Chart.js 全域設定 -----
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
        Chart.defaults.color = '#1f2937'; 
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.legend.labels.padding = 20;

        // ----- DOM 載入後執行 -----
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 0. 動態更新所有 KPI 數字 ---
            document.getElementById('kpi-total').textContent = finalDashboardData.totalCount;
            document.getElementById('kpi-external').textContent = finalDashboardData.totalExternal;
            document.getElementById('kpi-internal').textContent = finalDashboardData.totalInternal;
            
            // --- 1. 地理分佈圖 (依據 N=61 全體人員) ---
            const map = L.map('map').setView([23.1, 120.3], 9); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // (全新) 定義兩種標記
            const externalIcon = L.divIcon({
                className: 'morandi-marker-icon', // 琥珀色 (院外)
                iconSize: [20, 20]
            });
            
            const internalIcon = L.divIcon({
                className: 'morandi-marker-icon-internal', // 品牌藍 (院內)
                iconSize: [20, 20]
            });

            const locationsToMark = {};
            const cityCounts = {}; 
            let mappedCount = 0;
            const totalParticipants = finalDashboardData.totalCount;
            const totalInternal = finalDashboardData.totalInternal;
            const locationKeys = Object.keys(externalLocations);

            function findLocationInfo(unitString) {
                for (const key of locationKeys) {
                    if (unitString.includes(key)) {
                        return externalLocations[key];
                    }
                }
                return null;
            }

            finalDashboardData.externalParticipantsList.forEach(person => {
                const locationInfo = findLocationInfo(person.unit);
                
                if (locationInfo) {
                    mappedCount++; 
                    const geoKey = `${locationInfo.lat},${locationInfo.lon}`;
                    if (!locationsToMark[geoKey]) {
                        locationsToMark[geoKey] = { info: locationInfo, count: 0 };
                    }
                    locationsToMark[geoKey].count++;

                    const city = locationInfo.city;
                    if (city) {
                        if (!cityCounts[city]) cityCounts[city] = { internal: 0, external: 0 };
                        cityCounts[city].external++;
                    }
                }
            });

            const chimeiLocation = externalLocations["奇美醫院"];
            const chimeiGeoKey = `${chimeiLocation.lat},${chimeiLocation.lon}`;
            
            if (!locationsToMark[chimeiGeoKey]) {
                locationsToMark[chimeiGeoKey] = { info: chimeiLocation, count: 0 };
            }
            locationsToMark[chimeiGeoKey].count += totalInternal;

            const chimeiCity = chimeiLocation.city;
            if (!cityCounts[chimeiCity]) cityCounts[chimeiCity] = { internal: 0, external: 0 };
            cityCounts[chimeiCity].internal += totalInternal;

            mappedCount += totalInternal;

            const subtitleEl = document.getElementById('map-subtitle');
            subtitleEl.textContent = `(來源: 全體人員, N=${totalParticipants}, 標記 ${mappedCount}/${totalParticipants} 人)`;

            const cityContainer = document.getElementById('city-counts-container');
            cityContainer.innerHTML = ''; 

            const sortedCities = Object.keys(cityCounts).sort((a, b) => {
                const totalA = (cityCounts[a].internal || 0) + (cityCounts[a].external || 0);
                const totalB = (cityCounts[b].internal || 0) + (cityCounts[b].external || 0);
                return totalB - totalA;
            }); 

            for (const city of sortedCities) {
                const counts = cityCounts[city]; 

                if (city === "台南市") {
                    if (counts.internal > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'data-badge';
                        badge.style.backgroundColor = '#003566'; /* (全新) 院內 (品牌藍) */
                        badge.style.color = '#ffffff';
                        badge.textContent = `台南市 (院內) ${counts.internal} 人`;
                        cityContainer.appendChild(badge);
                    }
                    if (counts.external > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'data-badge';
                        badge.style.backgroundColor = '#fca311'; /* (全新) 院外 (琥珀黃) */
                        badge.style.color = '#1f2937'; /* (全新) 深色文字 */
                        badge.textContent = `台南市 (院外) ${counts.external} 人`;
                        cityContainer.appendChild(badge);
                    }
                } else {
                    const total = (counts.internal || 0) + (counts.external || 0);
                    if (total > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'data-badge';
                        badge.style.backgroundColor = '#fca311'; /* (全新) 院外 (琥珀黃) */
                        badge.style.color = '#1f2937'; /* (全新) 深色文字 */
                        badge.textContent = `${city} ${total} 人`;
                        cityContainer.appendChild(badge); 
                    } 
                }
            } 

            Object.values(locationsToMark).forEach(loc => {
                const popupContent = `
                    <div style="font-family: 'Noto Sans TC', sans-serif;">
                        <strong style="font-size: 1.1em;">${loc.info.name}</strong><br>
                        報名人數： ${loc.count} 人
                    </div>
                `;
                
                const iconToUse = (loc.info.type === 'internal') ? internalIcon : externalIcon;
                
                L.marker([loc.info.lat, loc.info.lon], { icon: iconToUse })
                    .addTo(map)
                    .bindPopup(popupContent);
            });

            // --- 2. (全新) 分組長條圖配色 ---
            const ctxGroup = document.getElementById('groupChart').getContext('2d');
            new Chart(ctxGroup, {
                type: 'bar',
                data: {
                    labels: finalDashboardData.groupRoleData.labels,
                    datasets: [
                        {
                            label: '資訊',
                            data: finalDashboardData.groupRoleData.it,
                            backgroundColor: '#003566', // 院內 (品牌藍)
                        },
                        {
                            label: '臨床',
                            data: finalDashboardData.groupRoleData.clinical,
                            backgroundColor: '#fca311', // 院外 (琥珀黃)
                        },
                        {
                            label: '非臨床',
                            data: finalDashboardData.groupRoleData.nonClinical,
                            backgroundColor: '#6b7280', // 中性色 (灰色)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        sum += tooltipItem.parsed.y;
                                    });
                                    return '本組總計: ' + sum + ' 人';
                                }
                            }
                        }
                    }
                }
            });

            // --- 3. (全新) 全體人員背景分析圖配色 ---
            const ctxCombined = document.getElementById('combinedAnalysisChart').getContext('2d');
            new Chart(ctxCombined, {
                type: 'doughnut',
                data: {
                    labels: ['院內同仁 (醫學中心)', '院外-醫學中心', '院外-診所', '院外-地區醫院', '院外-學校', '院外-其他'],
                    datasets: [{
                        label: '背景分析',
                        data: [
                            finalDashboardData.totalInternal,
                            finalDashboardData.externalAnalysis.byHospitalLevel.醫學中心,
                            finalDashboardData.externalAnalysis.byHospitalLevel.診所,
                            finalDashboardData.externalAnalysis.byHospitalLevel.地區醫院,
                            finalDashboardData.externalAnalysis.byType.學校,
                            finalDashboardData.externalAnalysis.byType.其他
                        ],
                        // (全新) 冷暖色分離
                        backgroundColor: [
                            '#003566', // 冷色 (院內)
                            '#fca311', // 暖色 1 (琥珀)
                            '#facc15', // 暖色 2
                            '#eab308', // 暖色 3
                            '#ca8a04', // 暖色 4
                            '#a16207'  // 暖色 5
                        ],
                        borderColor: '#FFFFFF',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const total = context.chart.getDatasetMeta(0).total;
                                        const value = context.parsed;
                                        const percentage = ((value / total) * 100).toFixed(1) + '%';
                                        label += `${value} 人 (${percentage})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

        });

    </script>
</body>
</html>
